<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>hadesflames:InvitationSystem</id>
	<version>1.0.4</version>
	
	<file name="$boarddir/index.php">
		<operation>
			<search position="replace"><![CDATA[
		'im' => array('PersonalMessage.php', 'MessageMain'),]]></search>
			<add><![CDATA[
		'im' => array('PersonalMessage.php', 'MessageMain'),
		'invite' => array('Invite.php', 'invite'),]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/Admin.php">
		<operation>
			<search position="after"><![CDATA[				'modsettings' => array(
					'label' => $txt['admin_modifications'],
					'file' => 'ManageSettings.php',
]]></search>
			<add><![CDATA[				'invite' => array(
					'label' => $txt['invite_system'],
					'file' => 'Invite.php',
					'function' => 'invite_admin',
					'icon' => 'invite.gif',
					'subsections' => array(
						'modify' => array($txt['invite_system_mod_settings']),
						'modifygroup' => array($txt['invite_system_mod_settings_group']),
						'email' => array($txt['invite_system_mod_email']),
						'manage' => array($txt['invite_system_mod_manage']),
						'generate' => array($txt['invite_system_mod_generate']),
					),
				),
]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/Subs.php">
		<operation>
			<search position="after"><![CDATA[			'profile' => array(
				'title' => $txt['profile'],
				'href' => $scripturl . '?action=profile',
				'show' => $context['allow_edit_profile'],
				'sub_buttons' => array(
					'summary' => array(
						'title' => $txt['summary'],
						'href' => $scripturl . '?action=profile',
						'show' => true,
					),
					'account' => array(
						'title' => $txt['account'],
						'href' => $scripturl . '?action=profile;area=account',
						'show' => allowedTo(array('profile_identity_any', 'profile_identity_own', 'manage_membergroups')),
					),
					'profile' => array(
						'title' => $txt['forumprofile'],
						'href' => $scripturl . '?action=profile;area=forumprofile',
						'show' => allowedTo(array('profile_extra_any', 'profile_extra_own')),
						'is_last' => true,
					),
				),
			),
]]></search>
			<add><![CDATA[			'invite' => array(
				'title' => $txt['invite'],
				'href' => $scripturl . '?action=invite',
				'show' => !$user_info['is_guest'],
				'sub_buttons' => array(
					'manage' => array(
						'title' => $txt['invite_manage'],
						'href' => $scripturl . '?action=invite;area=manage',
						'show' => true,
					),
					'generate' => array(
						'title' => $txt['invite_generate'],
						'href' => $scripturl . '?action=invite;area=generate',
						'show' => true,
					),
					'email' => array(
						'title' => $txt['invite_email_member'],
						'href' => $scripturl . '?action=invite;area=email',
						'show' => $modSettings['invite_email'] || allowedTo('admin_forum'),
						'is_last' => true,
					),
				),
			),
]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/ScheduledTasks.php">
		<operation>
			<search position="end" />
			<add><![CDATA[
// Invite System Mod			
function scheduled_invitePrune()
{
	global $smcFunc;
   
    $time = time() - (7 * 86400);
      
	$smcFunc['db_query']('', '
		DELETE FROM {db_prefix}invites
		WHERE active = 0
		AND time <= {int:time}',
		array(
			'time' => $time,
		)
	);

   return true;
}
function scheduled_keyExpire()
{
	global $smcFunc, $modSettings;
	
	if((int)$modSettings['key_expire'] == 0)
		return true;
	
	$time = time() - ((int)$modSettings['key_expire'] * 86400);
	
	$smcFunc['db_query']('', '
		UPDATE {db_prefix}invites
		SET active = 0
		WHERE time <= {int:time}',
		array(
			'time' => $time,
		)
	);

   return true;
}
function scheduled_keyRenew()
{
	global $smcFunc, $modSettings;
	
	$request = $smcFunc['db_query']('', '
		SELECT invite_count, invite_max, invite_roll_max, id_member
		FROM {db_prefix}members',
		array()
	);
	
	$invites = array();
	
	while($row = $smcFunc['db_fetch_assoc']($request))
	{
		if($row['invite_max'] == -1)
			continue;
		$invites[] = array(
			'id_member' => $row['id_member'],
			'invite_roll_max' => $modSettings['roll_over'] ? ($row['invite_roll_max'] - $row['invite_count']) + $row['invite_max'] : $row['invite_max'],
		);
	}
	
	$smcFunc['db_free_result']($request);
	
	foreach($invites as $member)
	{
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}members
			SET invite_count = 0
			WHERE id_member = {int:id}',
			array(
				'id' => $member['id_member'],
				'max' => $member['invite_roll_max'],
			)
		);
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}members
			SET invite_roll_max = {int:max}
			WHERE id_member = {int:id}',
			array(
				'id' => $member['id_member'],
				'max' => $member['invite_roll_max'],
			)
		);
	}

   return true;
}
]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/Register.php">
		<operation>
			<search position="after"><![CDATA[	$memberID = registerMember($regOptions, true);

	// What there actually an error of some kind dear boy?
	if (is_array($memberID))
]]></search>
			<add><![CDATA[	// If the invite mod is enabled, make sure they have a valid key.
	$register_inv = false;
	$key_inv = '';
	if ($modSettings['invite_enabled'])
	{
		$key = !empty($_POST['invite']) ? $_POST['invite'] : '';
		// Left the invite field blank ehh? No problems there =P
		if (empty($key))
			fatal_lang_error('invite_blank', false);
		else
		{
			$request = $smcFunc['db_query']('','
				SELECT inv.key, inv.active
				FROM {db_prefix}invites as inv
				WHERE inv.key = {string:key}
				LIMIT 1',
				array(
					'key' => (string)$key,
				)
			);
			
			// Hmm...wrong key? Looks like you don't have any friends in here after all =P
			if (!$smcFunc['db_num_rows']($request))
				fatal_lang_error('invite_wrong', false);
			else
			{
				// Almost done, first make sure the key is active though.
				$temp_key = array();
				while($row = $smcFunc['db_fetch_assoc']($request))
					$temp_key = $row;
				
				// Soooo close...Maybe next time =P
				if(!$temp_key['active'])
					fatal_lang_error('invite_wrong', false);
					
				// You made it! Welcome, friend.
				$register_inv = true;
				$key_inv = $key;
			}
			$smcFunc['db_free_result']($request);
		}
	}

]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[	// Do our spam protection now.
	spamProtection('register');
]]></search>
			<add><![CDATA[
	// Make sure the key gets de-activated AFTER spam protection ;)
	if($modSettings['invite_enabled']){
		if($register_inv){
			$smcFunc['db_query']('', '
				UPDATE {db_prefix}invites as inv
				SET inv.active = {int:active}
				WHERE inv.key = {string:key}
				LIMIT 1',
				array(
					'active' => 0,
					'key' => $key_inv,
				)
			);
		}
	}
]]></add>
		</operation>
	</file>
	
	<file name="$themedir/Register.template.php">
		<operation>
			<search position="before"><![CDATA[							<input type="password" name="passwrd2" id="smf_autov_pwverify" size="30" tabindex="', $context['tabindex']++, '" class="input_password" />
							<span id="smf_autov_pwverify_div" style="display: none;">
								<img id="smf_autov_pwverify_img" src="', $settings['images_url'], '/icons/field_valid.gif" alt="*" />
							</span>
						</dd>
					</dl>';
]]></search>
			<add><![CDATA[
	// Invite Key Input
	if ($modSettings['invite_enabled'])
	{
		echo '
					<dl class="register_form">
						<dt>
							<strong>', $txt['invite_reg_page'], '</strong>
						</dt>
						<dd>
							<input type="text" name="invite" size="30" tabindex="', $context['tabindex']++, '" value="" class="input_text" />
						</dd>
					</dl>
		';
	}
]]></add>
		</operation>
	</file>
</modification>
